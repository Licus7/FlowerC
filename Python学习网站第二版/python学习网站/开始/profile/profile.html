<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººæ¡£æ¡ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <style>
        :root {
            --primary-brown: #A0522D;
            --light-brown: #D2B48C;
            --dark-brown: #8B4513;
            --bg-color: #F5F5DC;
            --card-bg: #FFF8DC;
            --text-dark: #333;
            --text-light: #666;
            --success-green: #28a745;
        }

        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            color: var(--text-dark);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(160, 82, 45, 0.1);
            padding: 30px;
            margin-top: 20px;
        }

        /* è¿”å›æŒ‰é’® */
        .back-retro {
            display: inline-block;
            padding: 10px 25px;
            background: linear-gradient(135deg, var(--primary-brown), var(--dark-brown));
            color: white !important;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 6px rgba(139, 69, 19, 0.3);
            transition: all 0.3s;
        }

        .back-retro:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 69, 19, 0.4);
            color: white;
        }

        /* å¤´éƒ¨åŒºåŸŸ */
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--light-brown);
            margin-bottom: 30px;
        }

        .profile-img-container {
            position: relative;
            display: inline-block;
            margin-bottom: 20px;
        }

        .profile-img {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            object-fit: cover;
            background-color: #eee;
        }

        .edit-avatar-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-brown);
            color: white;
            border: 3px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s;
        }

        .edit-avatar-btn:hover {
            background: var(--dark-brown);
            transform: scale(1.1);
        }

        h1 {
            color: var(--primary-brown);
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* ä¸ªäººä¿¡æ¯å¡ç‰‡ */
        .profile-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--light-brown);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.1);
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 10px;
            border-left: 4px solid var(--primary-brown);
        }

        .info-label {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--dark-brown);
        }

        .info-value {
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--dark-brown);
        }

        /* ç¼–è¾‘æŒ‰é’® */
        .edit-btn {
            padding: 8px 20px;
            background: linear-gradient(to right, var(--primary-brown), var(--dark-brown));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(160, 82, 45, 0.3);
        }

        /* ç¼–è¾‘è¡¨å• */
        .edit-form {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid var(--light-brown);
            display: none;
        }

        .edit-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark-brown);
            margin-bottom: 8px;
        }

        .form-control {
            border: 2px solid var(--light-brown);
            border-radius: 10px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 0.2rem rgba(160, 82, 45, 0.25);
        }

        /* æ€§åˆ«é€‰æ‹© */
        .gender-selection {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .gender-option {
            flex: 1;
            text-align: center;
            cursor: pointer;
            padding: 15px;
            border: 2px solid var(--light-brown);
            border-radius: 10px;
            transition: all 0.3s;
            background: white;
        }

        .gender-option:hover {
            transform: translateY(-3px);
            border-color: var(--primary-brown);
        }

        .gender-option.selected {
            background: linear-gradient(135deg, var(--light-brown), var(--primary-brown));
            color: white;
            border-color: var(--primary-brown);
        }

        .gender-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        /* æŒ‰é’®ç»„ */
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn-save {
            flex: 2;
            padding: 12px;
            background: linear-gradient(to right, var(--success-green), #218838);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
        }

        .btn-cancel {
            flex: 1;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .btn-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* ç»éªŒè¿›åº¦æ¡ */
        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress {
            height: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-brown), #FFA500);
            transition: width 0.5s ease;
        }

        /* æœ‹å‹åˆ—è¡¨ */
        .friends-section {
            margin-top: 40px;
        }

        .friends-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .friend-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--light-brown);
            transition: all 0.3s;
            cursor: pointer;
        }

        .friend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(139, 69, 19, 0.15);
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--light-brown);
        }

        /* ç™»å‡ºæŒ‰é’® */
        #logoutButton {
            margin-top: 20px;
            padding: 12px 40px;
            background: linear-gradient(to right, #dc3545, #c82333);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s;
            width: 100%;
        }

        #logoutButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(220, 53, 69, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .gender-selection {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .friends-list {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* ä¿å­˜æç¤º */
        .save-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success-green);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .save-notification.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body>
     <div class="container">
        <!-- è¿”å›æŒ‰é’® -->
        <a href="../../menu.html" class="back-retro">
            <i class="fas fa-arrow-left"></i> è¿”å›èœå•
        </a>

        <!-- å¤´éƒ¨åŒºåŸŸ -->
        <header>
            <div class="profile-img-container">
                <img id="avatarImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=ç”¨æˆ·" alt="å¤´åƒ" class="profile-img">
                <div class="edit-avatar-btn" onclick="changeAvatar()">
                    <i class="fas fa-camera"></i>
                </div>
            </div>
            <h1>è§’è‰²æ¡£æ¡ˆ</h1>
        </header>

        <div class="info-item">
    <span class="info-label">å­¦ä¹ ç­‰çº§:</span>
    <span class="info-value" id="levelDisplay">ç­‰çº§1</span>
</div>

<div class="info-item">
    <span class="info-label">ç« èŠ‚å®Œæˆ:</span>
    <span class="info-value" id="lessonDisplay">0/8</span>
</div>

<div class="info-item">
    <span class="info-label">æ€»æ­£ç¡®ç‡:</span>
    <span class="info-value" id="accuracyDisplay">0%</span>
</div>

<!--å¯ä»¥åœ¨åº•éƒ¨æ·»åŠ é‡ç½®æŒ‰é’®-->
<button id="resetProgressBtn" class="btn btn-warning mt-3"
        style="background:#ffc107;color:#000;">
    <i class="fas fa-redo"></i>é‡ç½®ç­”é¢˜è¿›åº¦
</button>

        <!-- ä¸ªäººä¿¡æ¯æ˜¾ç¤ºåŒº -->
        <div class="profile-card">
            <div class="info-item">
                <span class="info-label">ç”¨æˆ·å:</span>
                <span class="info-value" id="usernameDisplay">æœªè®¾ç½®</span>
                <button class="edit-btn" onclick="editField('username')">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
            </div>

            <div class="info-item">
                <span class="info-label">è§’è‰²ID:</span>
                <span class="info-value" id="userIdDisplay">æœªè®¾ç½®</span>
                <button class="edit-btn" onclick="editField('userId')">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
            </div>

            <div class="info-item">
                <span class="info-label">æ€§åˆ«:</span>
                <span class="info-value" id="genderDisplay">æœªè®¾ç½®</span>
                <button class="edit-btn" onclick="editField('gender')">
                    <i class="fas fa-edit"></i> ç¼–è¾‘
                </button>
            </div>

            <div class="info-item">
                <span class="info-label">å¯†ç :</span>
                <span class="info-value">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                <button class="edit-btn" onclick="editField('password')">
                    <i class="fas fa-edit"></i> ä¿®æ”¹
                </button>
            </div>

            <!-- ç»éªŒè¿›åº¦æ¡ -->
            <div class="progress-container">
                <div class="progress-label">
                    <span>ç»éªŒå€¼</span>
                    <span id="experienceText">0/1000 XP</span>
                </div>
                <div class="progress">
                    <div id="experienceBar" class="progress-bar" style="width: 0%"></div>
                </div>
            </div>


        <!-- åœ¨å·²å®Œæˆè¯¾ç¨‹ä¸‹é¢æ·»åŠ  -->
<div class="info-item">
    <span class="info-label">BossçŠ¶æ€:</span>
    <span class="info-value" id="bossStatusDisplay" style="color: #dc3545;">æœªæˆ˜èƒœ</span>
</div>

<!-- ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªBossæˆ˜èƒœå¾½ç«  -->
<div id="bossBadge" style="display: none;" class="mt-3">
    <div class="alert alert-success">
        <i class="fas fa-trophy"></i> 
        <strong>Bosså¾æœè€…!</strong> å·²å‡»è´¥çº¢è‰²æš´é²¤é¾™ï¼
    </div>
</div>

        <!-- ç¼–è¾‘è¡¨å• -->
        <div id="editForm" class="edit-form">
            <h3 id="editTitle" style="color: var(--primary-brown); margin-bottom: 20px;">ç¼–è¾‘ä¿¡æ¯</h3>
            
            <div id="usernameEdit" class="form-group">
                <label class="form-label">ç”¨æˆ·å:</label>
                <input type="text" id="usernameInput" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>

            <div id="userIdEdit" class="form-group" style="display: none;">
                <label class="form-label">è§’è‰²ID:</label>
                <input type="text" id="userIdInput" class="form-control" placeholder="è¯·è¾“å…¥è§’è‰²ID">
            </div>

            <div id="genderEdit" class="form-group" style="display: none;">
                <label class="form-label">æ€§åˆ«:</label>
                <div class="gender-selection">
                    <div class="gender-option" onclick="selectGender('male')">
                        <div class="gender-icon">ğŸ‘¨</div>
                        <div>ç”·æ€§</div>
                    </div>
                    <div class="gender-option" onclick="selectGender('female')">
                        <div class="gender-icon">ğŸ‘©</div>
                        <div>å¥³æ€§</div>
                    </div>
                    <div class="gender-option" onclick="selectGender('other')">
                        <div class="gender-icon">ğŸ§‘</div>
                        <div>å…¶ä»–</div>
                    </div>
                </div>
            </div>

            <div id="passwordEdit" class="form-group" style="display: none;">
                <label class="form-label">æ–°å¯†ç :</label>
                <input type="password" id="passwordInput" class="form-control" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                <label class="form-label mt-3">ç¡®è®¤å¯†ç :</label>
                <input type="password" id="passwordConfirm" class="form-control" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
            </div>

            <div class="button-group">
                <button class="btn-save" onclick="saveChanges()">
                    <i class="fas fa-save"></i> ä¿å­˜æ›´æ”¹
                </button>
                <button class="btn-cancel" onclick="cancelEdit()">
                    <i class="fas fa-times"></i> å–æ¶ˆ
                </button>
            </div>
        </div>

        <!-- æœ‹å‹åˆ—è¡¨ -->
        <div class="friends-section">
            <h2 style="color: var(--primary-brown);">æˆ‘çš„å¥½å‹</h2>
            <div id="friendsList" class="friends-list">
                <!-- å¥½å‹ä¼šåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ç™»å‡ºæŒ‰é’® -->
        <button id="logoutButton" class="btn btn-danger mt-4">
            <i class="fas fa-sign-out-alt"></i> ç™»å‡ºè´¦æˆ·
        </button>
    </div>

    <!-- ä¿å­˜æˆåŠŸæç¤º -->
    <div id="saveNotification" class="save-notification">
        <i class="fas fa-check-circle"></i> ä¿å­˜æˆåŠŸï¼
    </div>

<script src="../progressManager.js"></script>

<script>
// ç”¨æˆ·æ•°æ®
let userData = {
    username: localStorage.getItem('userProfile_username') || '111',
    userId: localStorage.getItem('userProfile_userId') || 'ID_001',
    gender: localStorage.getItem('userProfile_gender') || 'male',
    password: localStorage.getItem('userProfile_password') || '123456',
    experience: parseInt(localStorage.getItem('userProfile_experience')) || 350,
    maxExperience: 1000,
    lessonsCompleted: parseInt(localStorage.getItem('userProfile_lessonsCompleted')) || 25,
    totalLessons: 100,
    friends: JSON.parse(localStorage.getItem('userProfile_friends')) || [
        { name: 'æå››', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=æå››' },
        { name: 'ç‹äº”', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=ç‹äº”' },
        { name: 'èµµå…­', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=èµµå…­' },
        { name: 'å°çº¢', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=å°çº¢' }
    ]
};

// å½“å‰ç¼–è¾‘çš„å­—æ®µ
let currentEditField = '';
let progressMgr = null;
let welcomeNotificationShown = false; // é˜²æ­¢é‡å¤æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('ä¸ªäººæ¡£æ¡ˆé¡µé¢åŠ è½½...');
    
    // ç­‰å¾… progressManager åŠ è½½
    setTimeout(function() {
        if (typeof ProgressManager === 'undefined') {
            console.log('æ‰‹åŠ¨åŠ è½½ ProgressManager');
            const script = document.createElement('script');
            script.src = '../progressManager.js';
            script.onload = initProfileProgress;
            script.onerror = function() {
                console.error('åŠ è½½progressManager.jså¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                initProfileProgress();
            };
            document.head.appendChild(script);
        } else {
            initProfileProgress();
        }
    }, 100);
});

function initProfileProgress() {
    console.log('åˆå§‹åŒ–ä¸ªäººæ¡£æ¡ˆè¿›åº¦...');
    
    // ç¡®ä¿ progressManager å®ä¾‹å­˜åœ¨
    if (!window.progressManager && typeof ProgressManager === 'function') {
        window.progressManager = new ProgressManager();
    }
    progressMgr = window.progressManager;
    
    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’Œè¿›åº¦
    showWelcomeProgress();
    
    // ç»§ç»­åŸæ¥çš„åˆå§‹åŒ–
    loadUserData();
    renderFriends();
    updateExperienceBar();
    syncProgressData();
    setupProgressListeners();
    setupResetButton();
}

// âœ… æ–°å¢ï¼šæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’Œè¿›åº¦
function showWelcomeProgress() {
    if (welcomeNotificationShown) return;
    
    setTimeout(() => {
        try {
            // æ–¹æ³•1ï¼šä»progressManagerè·å–
            if (window.progressManager) {
                const stats = window.progressManager.getStatsForDisplay();
                if (stats.hasData) {
                    showProgressNotification(stats);
                    welcomeNotificationShown = true;
                    return;
                }
            }
            
            // æ–¹æ³•2ï¼šä»localStorageç›´æ¥è¯»å–
            const oldScores = JSON.parse(localStorage.getItem('chapterScores') || '{}');
            let completedCount = 0;
            let latestChapter = 0;
            let latestScore = 0;
            
            for (let i = 1; i <= 10; i++) {
                if (oldScores[i] && oldScores[i] > 0) {
                    completedCount++;
                    latestChapter = i;
                    latestScore = oldScores[i];
                }
            }
            
            if (completedCount > 0) {
                showSimpleNotification(completedCount, latestChapter, latestScore);
                welcomeNotificationShown = true;
            }
        } catch (e) {
            console.warn('æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯æ—¶å‡ºé”™:', e);
        }
    }, 1500);
}

// âœ… æ–°å¢ï¼šæ˜¾ç¤ºè¯¦ç»†çš„è¿›åº¦é€šçŸ¥
function showProgressNotification(stats) {
    const messages = [];
    
    if (stats.completedChapters > 0) {
        messages.push(`å·²å®Œæˆ ${stats.completedChapters}/${stats.totalChapters} ç« `);
        messages.push(`å¹³å‡æ­£ç¡®ç‡: ${stats.accuracy}%`);
        
        if (stats.bossDefeated) {
            messages.push(`ğŸ‰ å·²æˆ˜èƒœBossï¼`);
        }
        
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.id = 'welcomeProgress';
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 9999;
            max-width: 300px;
            animation: slideInRight 0.5s ease-out;
            border-left: 5px solid #ffd700;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                <i class="fas fa-chart-line" style="font-size: 24px; margin-right: 10px;"></i>
                <h4 style="margin: 0;">å­¦ä¹ è¿›åº¦æŠ¥å‘Š</h4>
            </div>
            <div style="font-size: 14px; line-height: 1.5;">
                ${messages.map(msg => `<div>âœ… ${msg}</div>`).join('')}
            </div>
            <div style="text-align: right; margin-top: 10px; font-size: 12px;">
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 3px 10px; border-radius: 3px; cursor: pointer;">
                    å…³é—­
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 8ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'fadeOut 0.5s ease-out forwards';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }
        }, 8000);
    }
}

// âœ… æ–°å¢ï¼šç®€å•é€šçŸ¥
function showSimpleNotification(completedCount, latestChapter, latestScore) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideInRight 0.5s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center;">
            <i class="fas fa-trophy" style="font-size: 24px; margin-right: 10px;"></i>
            <div>
                <strong>æ¬¢è¿å›æ¥ï¼</strong><br>
                æ‚¨å·²å®Œæˆ ${completedCount} ä¸ªç« èŠ‚<br>
                æœ€è¿‘è¿›åº¦: ç¬¬${latestChapter}ç«  (${latestScore}åˆ†)
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'fadeOut 0.5s ease-out forwards';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 500);
        }
    }, 5000);
}

// âœ… ä¿®å¤ï¼šåŒæ­¥è¿›åº¦æ•°æ®
function syncProgressData() {
    console.log('åŒæ­¥è¿›åº¦æ•°æ®...');
    
    let stats = null;
    
    // æ–¹æ³•1ï¼šä½¿ç”¨progressManager
    if (window.progressManager) {
        stats = window.progressManager.getStatsForDisplay();
        console.log('ä»progressManagerè·å–æ•°æ®:', stats);
    } else {
        // æ–¹æ³•2ï¼šç›´æ¥ä»localStorageè¯»å–
        stats = getStatsFromLocalStorage();
        console.log('ä»localStorageè·å–æ•°æ®:', stats);
    }
    
    if (!stats) {
        console.warn('æ— æ³•è·å–è¿›åº¦æ•°æ®');
        return;
    }
    
    // âœ… å…³é”®ä¿®å¤ï¼šæ›´æ–°ç« èŠ‚æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºç« èŠ‚æ•°ï¼Œä¸æ˜¯ç™¾åˆ†æ¯”ï¼‰
    const lessonDisplay = document.getElementById('lessonDisplay');
    if (lessonDisplay) {
        // æ˜¾ç¤º "2/10ç« " è€Œä¸æ˜¯ç™¾åˆ†æ¯”
        lessonDisplay.textContent = `${stats.completedChapters}/${stats.totalChapters}ç« `;
        console.log('æ›´æ–°ç« èŠ‚æ˜¾ç¤ºä¸º:', lessonDisplay.textContent);
        
        // åŒæ—¶ä¿å­˜ç™¾åˆ†æ¯”åˆ°userDataï¼ˆä¸ºäº†å…¼å®¹å…¶ä»–ä»£ç ï¼‰
        userData.lessonsCompleted = stats.completionPercentage;
    }
    
    // æ›´æ–°æ­£ç¡®ç‡æ˜¾ç¤º
    updateAccuracyDisplay(stats.accuracy);
    
    // æ›´æ–°BossçŠ¶æ€æ˜¾ç¤º
    updateBossStatusDisplay(stats.bossDefeated);
    
    // æ›´æ–°ç»éªŒå€¼
    if (window.progressManager) {
        userData.experience = window.progressManager.calculateTotalExperience();
    } else {
        userData.experience = 350 + (stats.completedChapters * 50) + Math.round(stats.accuracy * 1.5);
        if (stats.bossDefeated) userData.experience += 300;
    }
    
    updateExperienceBar();
    saveUserData();
    
    console.log('åŒæ­¥å®Œæˆ:', stats);
}

// âœ… æ–°å¢ï¼šä»localStorageè·å–ç»Ÿè®¡æ•°æ®
function getStatsFromLocalStorage() {
    // ä¼˜å…ˆè¯»å–æ–°çš„è¿›åº¦æ ¼å¼
    const progress = JSON.parse(localStorage.getItem('userProgress_v3') || '{}');
    if (progress.chapters && Object.keys(progress.chapters).length > 0) {
        let completedCount = 0;
        let totalAccuracy = 0;
        let chapterCount = 0;
        
        for (const chapterId in progress.chapters) {
            const chapter = progress.chapters[chapterId];
            if (chapter.completed) completedCount++;
            if (chapter.accuracy > 0) {
                totalAccuracy += chapter.accuracy;
                chapterCount++;
            }
        }
        
        const avgAccuracy = chapterCount > 0 ? Math.round(totalAccuracy / chapterCount) : 0;
        
        return {
            completedChapters: completedCount,
            totalChapters: 10,
            accuracy: avgAccuracy,
            bossDefeated: progress.bossDefeated || false,
            completionPercentage: Math.round((completedCount / 10) * 100)
        };
    }
    
    // å¤‡ç”¨ï¼šè¯»å–æ—§çš„chapterScores
    const oldScores = JSON.parse(localStorage.getItem('chapterScores') || '{}');
    let completedCount = 0;
    let totalScore = 0;
    let chapterCount = 0;
    
    for (let i = 1; i <= 10; i++) {
        const score = oldScores[i];
        if (score && score > 0) {
            if (score >= 60) completedCount++;
            totalScore += score;
            chapterCount++;
        }
    }
    
    const avgScore = chapterCount > 0 ? Math.round(totalScore / chapterCount) : 0;
    
    return {
        completedChapters: completedCount,
        totalChapters: 10,
        accuracy: avgScore,
        bossDefeated: localStorage.getItem('boss_defeated') === 'true',
        completionPercentage: Math.round((completedCount / 10) * 100)
    };
}

// âœ… æ–°å¢ï¼šæ›´æ–°æ­£ç¡®ç‡æ˜¾ç¤º
function updateAccuracyDisplay(accuracy) {
    let accuracyDisplay = document.getElementById('accuracyDisplay');
    
    if (!accuracyDisplay) {
        // åˆ›å»ºæ­£ç¡®ç‡æ˜¾ç¤º
        const profileCard = document.querySelector('.profile-card');
        if (profileCard) {
            // å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¯èƒ½åœ¨HTMLä¸­å·²å®šä¹‰ï¼‰
            accuracyDisplay = document.getElementById('accuracyDisplay');
            if (!accuracyDisplay) {
                const accuracyItem = document.createElement('div');
                accuracyItem.className = 'info-item';
                accuracyItem.innerHTML = `
                    <span class="info-label">æ€»æ­£ç¡®ç‡:</span>
                    <span class="info-value" id="accuracyDisplay">${accuracy}%</span>
                `;
                profileCard.appendChild(accuracyItem);
                accuracyDisplay = document.getElementById('accuracyDisplay');
            }
        }
    }
    
    if (accuracyDisplay) {
        accuracyDisplay.textContent = `${accuracy}%`;
    }
}

// âœ… æ–°å¢ï¼šæ›´æ–°BossçŠ¶æ€æ˜¾ç¤º
function updateBossStatusDisplay(bossDefeated) {
    let bossStatusDisplay = document.getElementById('bossStatusDisplay');
    
    if (!bossStatusDisplay) {
        const profileCard = document.querySelector('.profile-card');
        if (profileCard) {
            bossStatusDisplay = document.getElementById('bossStatusDisplay');
            if (!bossStatusDisplay) {
                const bossItem = document.createElement('div');
                bossItem.className = 'info-item';
                bossItem.innerHTML = `
                    <span class="info-label">BossçŠ¶æ€:</span>
                    <span class="info-value" id="bossStatusDisplay" 
                          style="color: ${bossDefeated ? '#28a745' : '#dc3545'}">
                        ${bossDefeated ? 'å·²æˆ˜èƒœ' : 'æœªæˆ˜èƒœ'}
                    </span>
                `;
                profileCard.appendChild(bossItem);
            }
        }
    }
    
    if (bossStatusDisplay) {
        bossStatusDisplay.textContent = bossDefeated ? 'å·²æˆ˜èƒœ' : 'æœªæˆ˜èƒœ';
        bossStatusDisplay.style.color = bossDefeated ? '#28a745' : '#dc3545';
    }
}

// è®¾ç½®è¿›åº¦ç›‘å¬å™¨
function setupProgressListeners() {
    // ç›‘å¬storageäº‹ä»¶
    window.addEventListener('storage', function(e) {
        if (e.key === 'userProgress_v3' || e.key === 'chapterScores') {
            console.log('æ£€æµ‹åˆ°è¿›åº¦æ›´æ–°:', e.key);
            syncProgressData();
            
            // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
            showUpdateNotification();
        }
    });
    
    // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
    window.addEventListener('message', function(event) {
        if (event.data && (event.data.type === 'progressUpdate' || event.data.type === 'bossVictory')) {
            console.log('æ”¶åˆ°è¿›åº¦æ›´æ–°æ¶ˆæ¯:', event.data.type);
            syncProgressData();
            
            // æ˜¾ç¤ºç‰¹å®šé€šçŸ¥
            if (event.data.type === 'bossVictory') {
                showBossVictoryNotification();
            } else {
                showUpdateNotification();
            }
        }
    });
    
    // ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
    window.addEventListener('progressUpdated', function(event) {
        console.log('æ”¶åˆ°è¿›åº¦æ›´æ–°äº‹ä»¶');
        if (event.detail) {
            syncProgressData();
            showUpdateNotification();
        }
    });
}

// âœ… æ–°å¢ï¼šæ˜¾ç¤ºæ›´æ–°é€šçŸ¥
function showUpdateNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 9999;
        animation: slideInUp 0.5s ease-out;
        font-size: 14px;
    `;
    
    notification.innerHTML = `
        <i class="fas fa-sync-alt"></i> è¿›åº¦å·²æ›´æ–°
        <span style="margin-left: 5px; font-size: 12px;">${new Date().toLocaleTimeString().slice(0,5)}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'fadeOut 0.5s ease-out forwards';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 500);
        }
    }, 3000);
}

// âœ… æ–°å¢ï¼šBossæˆ˜èƒœé€šçŸ¥
function showBossVictoryNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
        color: #8b4513;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: popIn 0.5s ease-out;
        text-align: center;
        min-width: 300px;
        border: 3px solid gold;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ†</div>
        <h3 style="margin: 0 0 10px 0;">BOSS æˆ˜èƒœï¼</h3>
        <p style="margin: 0;">æ­å–œå‡»è´¥çº¢è‰²æš´é²¤é¾™ï¼</p>
        <p style="margin: 5px 0 15px 0; font-size: 14px;">è¿›åº¦å·²åŒæ­¥åˆ°ä¸ªäººæ¡£æ¡ˆ</p>
        <button onclick="this.parentElement.parentElement.remove()" 
                style="background: #8b4513; color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer;">
            ç¡®å®š
        </button>
    `;
    
    document.body.appendChild(notification);
}

// è®¾ç½®é‡ç½®æŒ‰é’®
function setupResetButton() {
    const resetBtn = document.getElementById('resetProgressBtn');
    if (!resetBtn) return;
    
    resetBtn.addEventListener('click', function() {
        if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç­”é¢˜è¿›åº¦å—ï¼Ÿ\nè¿™å°†æ¸…é™¤ï¼š\nâ€¢ æ‰€æœ‰ç« èŠ‚è¿›åº¦\nâ€¢ Bossæˆ˜èƒœè®°å½•\nâ€¢ ç­”é¢˜ç»éªŒå€¼')) {
            if (window.progressManager) {
                window.progressManager.resetProgress();
            } else {
                // æ¸…é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
                localStorage.removeItem('userProgress_v3');
                localStorage.removeItem('chapterScores');
                localStorage.removeItem('chapterAttempts');
                localStorage.removeItem('boss_defeated');
                
                for (let i = 1; i <= 10; i++) {
                    localStorage.removeItem(`chapter_${i}_progress`);
                }
                
                userData.experience = 350;
                userData.lessonsCompleted = 0;
                localStorage.setItem('userProfile_experience', '350');
                localStorage.setItem('userProfile_lessonsCompleted', '0');
            }
            
            syncProgressData();
            
            // æ˜¾ç¤ºé‡ç½®é€šçŸ¥
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #dc3545;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 9999;
            `;
            notification.textContent = 'âœ… è¿›åº¦å·²é‡ç½®ï¼';
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }
    });
}

// ==================== ä»¥ä¸‹æ˜¯åŸæœ‰å‡½æ•°ï¼Œä¿æŒä¸åŠ¨ ====================

function loadUserData() {
    document.getElementById('usernameDisplay').textContent = userData.username;
    document.getElementById('userIdDisplay').textContent = userData.userId;
    
    let genderText = '';
    switch(userData.gender) {
        case 'male': genderText = 'ç”·æ€§'; break;
        case 'female': genderText = 'å¥³æ€§'; break;
        default: genderText = 'å…¶ä»–'; break;
    }
    document.getElementById('genderDisplay').textContent = genderText;
}

function renderFriends() {
    const friendsList = document.getElementById('friendsList');
    if (!friendsList) return;
    
    friendsList.innerHTML = '';
    userData.friends.forEach(friend => {
        const friendCard = `
            <div class="friend-card">
                <img src="${friend.avatar}" alt="${friend.name}" class="friend-avatar">
                <div style="font-weight:600;color:#333">${friend.name}</div>
                <div style="font-size:.9rem;color:#666">åœ¨çº¿</div>
            </div>`;
        friendsList.innerHTML += friendCard;
    });
}

function updateExperienceBar() {
    const experienceBar = document.getElementById('experienceBar');
    const experienceText = document.getElementById('experienceText');
    
    if (!experienceBar || !experienceText) return;
    
    const level = Math.floor(userData.experience / 500) + 1;
    const currentLevelMinXP = (level - 1) * 500;
    const currentLevelProgress = userData.experience - currentLevelMinXP;
    const currentLevelTotal = 500;
    const percentage = Math.min((currentLevelProgress / currentLevelTotal) * 100, 100);
    
    experienceBar.style.width = `${percentage}%`;
    experienceText.textContent = 
        `Lv.${level} ${userData.experience}/${level * 500} XP`;
}

function editField(field) {
    currentEditField = field;
    document.getElementById('usernameEdit').style.display = 'none';
    document.getElementById('userIdEdit').style.display = 'none';
    document.getElementById('genderEdit').style.display = 'none';
    document.getElementById('passwordEdit').style.display = 'none';
    
    const editForm = document.getElementById('editForm');
    editForm.classList.add('active');
    
    document.querySelectorAll('.gender-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    switch(field) {
        case 'username':
            document.getElementById('editTitle').textContent = 'ç¼–è¾‘ç”¨æˆ·å';
            document.getElementById('usernameEdit').style.display = 'block';
            document.getElementById('usernameInput').value = userData.username;
            break;
        case 'userId':
            document.getElementById('editTitle').textContent = 'ç¼–è¾‘è§’è‰²ID';
            document.getElementById('userIdEdit').style.display = 'block';
            document.getElementById('userIdInput').value = userData.userId;
            break;
        case 'gender':
            document.getElementById('editTitle').textContent = 'é€‰æ‹©æ€§åˆ«';
            document.getElementById('genderEdit').style.display = 'block';
            const genderOption = document.querySelector(`.gender-option[onclick*="${userData.gender}"]`);
            if (genderOption) genderOption.classList.add('selected');
            break;
        case 'password':
            document.getElementById('editTitle').textContent = 'ä¿®æ”¹å¯†ç ';
            document.getElementById('passwordEdit').style.display = 'block';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordConfirm').value = '';
            break;
    }
}

function selectGender(gender) {
    document.querySelectorAll('.gender-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    const selectedOption = document.querySelector(`.gender-option[onclick*="${gender}"]`);
    if (selectedOption) selectedOption.classList.add('selected');
    
    let genderText = '';
    switch(gender) {
        case 'male': genderText = 'ç”·æ€§'; break;
        case 'female': genderText = 'å¥³æ€§'; break;
        default: genderText = 'å…¶ä»–'; break;
    }
    document.getElementById('genderDisplay').textContent = genderText;
}

function saveChanges() {
    switch(currentEditField) {
        case 'username':
            const newUsername = document.getElementById('usernameInput').value.trim();
            if (newUsername) {
                userData.username = newUsername;
                localStorage.setItem('userProfile_username', newUsername);
                document.getElementById('usernameDisplay').textContent = newUsername;
            }
            break;
        case 'userId':
            const newUserId = document.getElementById('userIdInput').value.trim();
            if (newUserId) {
                userData.userId = newUserId;
                localStorage.setItem('userProfile_userId', newUserId);
                document.getElementById('userIdDisplay').textContent = newUserId;
            }
            break;
        case 'gender':
            const selectedGender = document.querySelector('.gender-option.selected');
            if (selectedGender) {
                const onclickAttr = selectedGender.getAttribute('onclick');
                const genderMatch = onclickAttr.match(/'([^']+)'/);
                if (genderMatch) {
                    userData.gender = genderMatch[1];
                    localStorage.setItem('userProfile_gender', genderMatch[1]);
                }
            }
            break;
        case 'password':
            const newPassword = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('passwordConfirm').value;
            
            if (!newPassword) {
                alert('è¯·è¾“å…¥æ–°å¯†ç ï¼');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }
            
            userData.password = newPassword;
            localStorage.setItem('userProfile_password', newPassword);
            alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            break;
    }
    
    cancelEdit();
    showNotification();
}

function cancelEdit() {
    document.getElementById('editForm').classList.remove('active');
    currentEditField = '';
    loadUserData();
}

function changeAvatar() {
    const avatarSeed = prompt('è¯·è¾“å…¥å¤´åƒç§å­ï¼ˆè‹±æ–‡æˆ–æ•°å­—ï¼‰:', 'ç”¨æˆ·');
    if (avatarSeed) {
        const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(avatarSeed)}`;
        document.getElementById('avatarImg').src = avatarUrl;
        localStorage.setItem('userProfile_avatar', avatarUrl);
        showNotification();
    }
}

function showNotification() {
    const notification = document.getElementById('saveNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 2000);
}

function saveUserData() {
    localStorage.setItem('userProfile_experience', userData.experience.toString());
    localStorage.setItem('userProfile_lessonsCompleted', userData.lessonsCompleted.toString());
}

// ç™»å‡ºåŠŸèƒ½
document.getElementById('logoutButton').addEventListener('click', function() {
    if (confirm('ç¡®å®šè¦ç™»å‡ºè´¦æˆ·å—ï¼Ÿ')) {
        sessionStorage.removeItem('isLoggedIn');
        alert('å·²ç™»å‡ºï¼');
        window.location.href = '../../login.html';
    }
});

// æ·»åŠ CSSåŠ¨ç”»
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideInUp {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; transform: translateY(-20px); }
    }
    
    @keyframes popIn {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        70% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
</body>
</html>